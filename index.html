<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MealPass — Scan. Serve. Simplified.</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
/* ---------- SPLASH ANIMATION ---------- */
@keyframes logoIn {
  0% { opacity: 0; transform: scale(0.85); }
  100% { opacity: 1; transform: scale(1); }
}
@keyframes fadeOut {
  to { opacity: 0; visibility: hidden; }
}
.splash-logo {
  animation: logoIn 0.8s ease-out forwards;
}
.splash-hide {
  animation: fadeOut 0.6s ease-in forwards;
}
</style>
</head>

<body class="bg-[#4b146b] text-white overflow-hidden">

<!-- ================= SPLASH SCREEN ================= -->
<div id="splash"
  class="fixed inset-0 flex flex-col items-center justify-center bg-[#4b146b] z-50">

  <!-- LOGO (SVG EMBED) -->
  <svg width="180" height="180" viewBox="0 0 512 512" class="splash-logo">
    <rect width="512" height="512" rx="48" fill="#5b1a86"/>
    <!-- Dome -->
    <path d="M96 256h320c0-106-86-192-192-192S96 150 96 256z" fill="white"/>
    <!-- Fork -->
    <rect x="248" y="160" width="16" height="96" fill="#5b1a86"/>
    <rect x="232" y="160" width="12" height="48" fill="#5b1a86"/>
    <rect x="268" y="160" width="12" height="48" fill="#5b1a86"/>
    <!-- Speed lines -->
    <rect x="96" y="240" width="120" height="12" rx="6" fill="white"/>
    <rect x="96" y="272" width="160" height="12" rx="6" fill="white"/>
  </svg>

  <h1 class="mt-6 text-4xl font-extrabold tracking-wider">
    MEALPASS
  </h1>
  <p class="mt-2 text-sm tracking-widest opacity-80">
    SCAN. SERVE. SIMPLIFIED.
  </p>
</div>

<!-- ================= APP CONTENT ================= -->
<div id="app" class="hidden min-h-screen bg-gradient-to-b from-[#1f1b2e] to-[#36284a] p-4">

  <!-- LOGIN PLACEHOLDER -->
  <div class="max-w-sm mx-auto mt-20 bg-white/10 p-6 rounded-xl text-center">
    <h2 class="text-2xl font-bold text-purple-300">MealPass</h2>
    <p class="text-sm text-gray-300 mb-4">Scan. Serve. Simplified.</p>

    <input class="w-full p-2 mb-2 rounded text-black" placeholder="Email">
    <input type="password" class="w-full p-2 mb-3 rounded text-black" placeholder="Password">

    <button class="w-full py-2 bg-purple-600 rounded font-semibold">
      Login
    </button>
  </div>

  <footer class="text-center text-xs text-gray-400 mt-10">
    © 2026 MealPass. All rights reserved.
  </footer>
</div>

<script>
/* ---------- SPLASH TIMING ---------- */
setTimeout(() => {
  document.getElementById("splash").classList.add("splash-hide");
  document.getElementById("app").classList.remove("hidden");
  document.body.classList.remove("overflow-hidden");
}, 2000);

/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyDlgdYJ9-3ELhEjLz8EQJQK18ghlWhR-jo",
  authDomain: "orc-meal-tracker.firebaseapp.com",
  projectId: "orc-meal-tracker"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- CONFIG ---------- */
const MEALS = ["breakfast","lunch","dinner"];
let currentMeal = "breakfast";
let scanner = null;

/* ---------- INIT MEALS ---------- */
MEALS.forEach(m=>{
  const o=document.createElement("option");
  o.value=m; o.textContent=m;
  mealSelect.appendChild(o);
});
mealSelect.onchange=e=>currentMeal=e.target.value;

/* ---------- AUTH ---------- */
function login(){
  auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value);
}
function logout(){
  stopScanner();
  auth.signOut();
}

/* ---------- ROLE HANDLER ---------- */
auth.onAuthStateChanged(user=>{
  if(!user){
    loginScreen.style.display="flex";
    app.classList.add("hidden");
    return;
  }
  loginScreen.style.display="none";
  app.classList.remove("hidden");

  db.collection("users").doc(user.uid).onSnapshot(doc=>{
    const role = doc.data().role;
    roleText.textContent = "Role: " + role;

    adminPanel.style.display = role==="admin" ? "block" : "none";
    volunteerPanel.style.display = role==="volunteer" ? "block" : "none";

    if(role==="admin") loadUsers();
  });
});

/* ---------- USER MANAGEMENT ---------- */
function loadUsers(){
  db.collection("users").orderBy("createdAt").onSnapshot(snap=>{
    userList.innerHTML="";
    snap.forEach(doc=>{
      const u = doc.data();
      userList.innerHTML += `
<li class="bg-black/30 p-3 rounded flex flex-col sm:flex-row justify-between gap-2">
  <div>
    <p>${u.email}</p>
    <p class="text-xs text-gray-400">${u.role}</p>
  </div>
  <div class="flex gap-2 flex-wrap">
    <button onclick="setRole('${doc.id}','volunteer')" class="px-3 py-1 bg-blue-600 text-xs rounded">Volunteer</button>
    <button onclick="setRole('${doc.id}','admin')" class="px-3 py-1 bg-red-600 text-xs rounded">Admin</button>
    <button onclick="setRole('${doc.id}','disabled')" class="px-3 py-1 bg-gray-700 text-xs rounded">Disable</button>
  </div>
</li>`;
    });
  });
}
function setRole(uid, role){
  if(uid === auth.currentUser.uid && role === "admin"){
    alert("Self promotion blocked");
    return;
  }
  db.collection("users").doc(uid).update({ role });
}

/* ---------- EXCEL UPLOAD ---------- */
excelFile.onchange = async e => {
  const file = e.target.files[0];
  const r = new FileReader();
  r.onload = async ev => {
    const wb = XLSX.read(new Uint8Array(ev.target.result), {type:"array"});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    const col = Object.keys(rows[0])[0];

    const old = await db.collection("allowed_ids").get();
    const batch = db.batch();
    old.forEach(d=>batch.delete(d.ref));
    await batch.commit();

    let count=0;
    for(const row of rows){
      const id = String(row[col]).trim().toUpperCase();
      if(!id) continue;
      await db.collection("allowed_ids").doc(id).set({active:true});
      count++;
    }
    excelCount.textContent = `${count} IDs uploaded`;
  };
  r.readAsArrayBuffer(file);
};

/* ---------- SCANNER ---------- */
async function startScanner(){
  if(scanner) return;
  startBtn.disabled=true; stopBtn.disabled=false;
  scanner = new Html5Qrcode("reader");
  await scanner.start({facingMode:"environment"},{fps:10,qrbox:250},onScan);
}
async function stopScanner(){
  if(!scanner) return;
  await scanner.stop(); await scanner.clear();
  scanner=null;
  reader.textContent="Camera stopped";
  startBtn.disabled=false; stopBtn.disabled=true;
}

/* ---------- SCAN HANDLER ---------- */
async function onScan(text){
  await stopScanner();
  const id = text.trim().toUpperCase();

  const allowed = await db.collection("allowed_ids").doc(id).get();
  if(!allowed.exists){ showScan("Invalid ID"); return; }

  const ref = db.collection("meal_records").doc(id);
  const snap = await ref.get();
  const today = new Date().toISOString().split("T")[0];
  let meals = snap.exists ? snap.data().meals || {} : {};

  if(meals[currentMeal]?.date === today){
    showScan("Already Taken");
  } else {
    meals[currentMeal] = { date: today, time: new Date().toLocaleTimeString() };
    await ref.set({ id, meals }, { merge:true });
    showScan("Allowed");
  }
}

/* ---------- SCAN MODAL ---------- */
function showScan(text){
  scanText.textContent=text;
  scanModal.classList.remove("hidden");
}
function closeScanModal(){
  scanModal.classList.add("hidden");
  startScanner();
}

/* ---------- REPORT ---------- */
function openReport(){ reportModal.classList.remove("hidden"); }
function closeReport(){ reportModal.classList.add("hidden"); }
async function downloadReport(type){
  closeReport();
  const snap = await db.collection("meal_records").get();
  const rows=[];
  snap.forEach(d=>{
    const m=d.data().meals||{};
    Object.keys(m).forEach(k=>{
      if(type==="today" && m[k].date!==new Date().toISOString().split("T")[0]) return;
      rows.push({ID:d.id,Meal:k,Date:m[k].date,Time:m[k].time});
    });
  });
  if(!rows.length) return alert("No data");
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Report");
  XLSX.writeFile(wb,`meal_report_${type}.xlsx`);
}
</script>
</script>

</body>
</html>
