<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ORC Meal Tracker — Purple & Gray (Responsive)</title>

  <!-- Tailwind for utilities (we use some, but added custom CSS for responsiveness) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTML5 QR Code -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg1:#1f1b2e;
      --bg2:#3b2a57;
      --muted:#9aa0a6;
      --accent:#8b5cf6;
      --accent-2:#6d28d9;
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef8;-webkit-font-smoothing:antialiased}
    .page {
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }

    /* Card */
    .card {
      width:100%;
      max-width:960px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:18px;
      box-shadow:0 10px 40px rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.04);
      box-sizing:border-box;
    }

    .head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .brand {
      display:flex;
      flex-direction:column;
    }
    .brand h1{margin:0;color:var(--accent);font-size:20px}
    .brand p{margin:4px 0 0;color:var(--muted);font-size:13px}

    /* layout: left = controls, right = camera */
    .layout {
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      align-items:start;
    }

    /* Left panel controls */
    .controls {
      background:transparent;
      padding:8px;
      border-radius:10px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .meals {
      display:flex;
      gap:8px;
    }
    .meal-btn {
      flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      background:transparent;color:#edf2ff;font-weight:700;cursor:pointer;
      transition:all .14s;
    }
    .meal-btn:hover{transform:translateY(-3px)}
    .meal-btn.active{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 10px 30px rgba(109,40,217,0.18);
    }

    .file-row {
      display:flex;gap:8px;align-items:center;
      background:rgba(255,255,255,0.02);
      padding:10px;border-radius:10px;border:1px dashed rgba(255,255,255,0.03);
    }
    .file-row .txt {flex:1;color:var(--muted);font-size:13px}
    .file-row input[type=file]{color:inherit}

    .btn-row {display:flex;gap:8px;flex-wrap:wrap}
    .btn {
      padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;color:white;
      display:inline-flex;align-items:center;gap:8px;justify-content:center;
      min-width:110px;
    }
    .btn-start{background:linear-gradient(90deg,#10b981,#059669)}
    .btn-stop{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .btn-download{background:linear-gradient(90deg,var(--accent),var(--accent-2))}

    .small {font-size:12px;color:var(--muted)}

    /* Camera area */
    .camera-card {
      border-radius:12px;
      padding:8px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
    }
    #reader {
      width:100%;
      height:420px;
      border-radius:10px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,#071427,#0b1220);
      border:4px solid rgba(255,255,255,0.04);
    }

    .status-card {
      border-radius:10px;padding:10px;background:rgba(255,255,255,0.02);text-align:center;
    }
    .big-msg {font-weight:800;font-size:20px}

    /* responsive: stack controls on top for narrow screens */
    @media (max-width:880px) {
      .layout { grid-template-columns: 1fr; }
      #reader { height:320px; }
      .brand { align-items:flex-start }
    }
    @media (max-width:480px) {
      .card { padding:12px; border-radius:10px; }
      #reader { height:260px; }
      .meal-btn{padding:9px;font-size:14px}
      .btn{min-width:unset;padding:9px 10px}
      .big-msg{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card" role="application" aria-label="Meal Tracker">
      <div class="head">
        <div class="brand">
          <h1>ORC Meal Tracker</h1>
          <p>Upload Excel → Scan QR → Allowed / Already Taken</p>
        </div>
        <div class="small">Firestore: <strong>meal_records</strong></div>
      </div>

      <div class="layout" aria-live="polite">
        <!-- LEFT: controls -->
        <div class="controls" aria-hidden="false">
          <div>
            <div class="meals" role="tablist">
              <button id="breakfastBtn" class="meal-btn active" aria-pressed="true">Breakfast</button>
              <button id="lunchBtn" class="meal-btn" aria-pressed="false">Lunch</button>
              <button id="dinnerBtn" class="meal-btn" aria-pressed="false">Dinner</button>
            </div>
          </div>

          <div class="file-row" role="group" aria-label="Excel upload">
            <div class="txt">Upload Excel (first sheet with ID column)</div>
            <input id="excelFile" type="file" accept=".xlsx,.xls" />
          </div>

          <div class="btn-row">
            <button id="startBtn" class="btn btn-start" disabled>Start Scanning</button>
            <button id="stopBtn" class="btn btn-stop" disabled>Stop</button>
            <button id="downloadBtn" class="btn btn-download">Download Report</button>
          </div>

          <div id="fileStatus" class="small" style="margin-top:8px">No file loaded</div>
        </div>

        <!-- RIGHT: camera -->
        <div class="camera-card">
          <div id="reader">Camera preview will appear here</div>

          <div class="status-card">
            <div id="status" class="small">Upload Excel file to begin.</div>
            <div id="message" class="big-msg mt-2" aria-live="assertive"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  // ---------- CONFIG: your firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDlgdYJ9-3ELhEjLz8EQJQK18ghlWhR-jo",
    authDomain: "orc-meal-tracker.firebaseapp.com",
    projectId: "orc-meal-tracker",
    storageBucket: "orc-meal-tracker.firebasestorage.app",
    messagingSenderId: "817313784849",
    appId: "1:817313784849:web:a6597e3981c33c911dbdb0",
    measurementId: "G-H4X37NMPRH"
  };
  // ------------------------------------------------------------------------

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  await signInAnonymously(auth);

  // DOM refs
  const excelFile = document.getElementById('excelFile');
  const fileStatus = document.getElementById('fileStatus');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const statusEl = document.getElementById('status');
  const messageEl = document.getElementById('message');

  const breakfastBtn = document.getElementById('breakfastBtn');
  const lunchBtn = document.getElementById('lunchBtn');
  const dinnerBtn = document.getElementById('dinnerBtn');

  // scanner
  const readerId = 'reader';
  const html5QrCode = new Html5Qrcode(readerId);
  let scannerActive = false;
  let validIDs = new Set();
  let currentMeal = 'breakfast';

  // helpers
  function todayKey(){ return new Date().toISOString().split('T')[0]; }
  function nowTime(){ return new Date().toLocaleTimeString(); }
  function setStatus(text){ statusEl.textContent = text; }
  function showMessage(text, type='info'){
    messageEl.textContent = text;
    if(type === 'success') messageEl.style.color = '#e6fffa';
    else if(type === 'error') messageEl.style.color = '#ffe4e6';
    else messageEl.style.color = '#e0e7ff';
    // clear after 2.5s
    setTimeout(()=> { if(messageEl.textContent === text) messageEl.textContent = ''; }, 2500);
  }

  // ID extraction (unchanged robust logic)
  function extractId(scanned){
    if(!scanned) return null;
    const raw = String(scanned).trim();
    const up = raw.toUpperCase();
    if(validIDs.has(up)) return up;
    const m = raw.match(/(?:ID|REGISTRATION_ID|REGID|REG|UID|STUDENT_ID)=([A-Za-z0-9\-_]+)/i);
    if(m && m[1]){ const cand = m[1].toUpperCase(); if(validIDs.has(cand)) return cand; }
    const tokens = up.split(/[^A-Z0-9\-_]+/).filter(Boolean);
    for(const t of tokens) if(validIDs.has(t)) return t;
    if(validIDs.size > 0 && validIDs.size <= 5000){ for(const id of validIDs) if(up.includes(id)) return id; }
    return null;
  }

  // scan handler
  async function onScanSuccess(decodedText){
    try { await html5QrCode.stop(); } catch(e){/*ignore*/}
    scannerActive = false;
    setStatus('Processing...');
    const id = extractId(decodedText);
    if(!id){
      showMessage('❌ Invalid QR', 'error');
      setStatus('Invalid QR — ready');
      setTimeout(startScanner, 1200);
      return;
    }

    try {
      const docRef = doc(db, 'meal_records', id);
      const snap = await getDoc(docRef);
      const date = todayKey();
      const mealDateKey = `${currentMeal}_date`;
      const mealTimeKey = `${currentMeal}_time`;

      if(snap.exists()){
        const data = snap.data();
        const meals = data.meals || {};
        if(meals[mealDateKey] === date){
          showMessage('❌ Already Taken', 'error');
        } else {
          const updatedMeals = { ...meals, [mealDateKey]: date, [mealTimeKey]: nowTime() };
          await updateDoc(docRef, { meals: updatedMeals, lastUpdate: new Date() });
          showMessage('✅ Allowed', 'success');
        }
      } else {
        const newMeals = { [mealDateKey]: date, [mealTimeKey]: nowTime() };
        await setDoc(docRef, { id, meals: newMeals, registeredAt: new Date(), lastUpdate: new Date() });
        showMessage('✅ Allowed', 'success');
      }
      setStatus(`Processed ${id} — ready for next.`);
    } catch(err){
      console.error('Save error', err);
      showMessage('❌ Save failed', 'error');
      setStatus('Save error — check console.');
    } finally {
      setTimeout(startScanner, 1000);
    }
  }

  // start/stop scanner
  async function startScanner(){
    if(validIDs.size === 0){ setStatus('Upload Excel first.'); return; }
    setStatus('Starting camera — allow permission...');
    try {
      const cams = await Html5Qrcode.getCameras();
      if(!cams || cams.length === 0) throw new Error('No camera found');
      let cam = cams[0];
      for(const c of cams){
        const lab = (c.label || '').toLowerCase();
        if(lab.includes('back') || lab.includes('rear') || lab.includes('environment')) { cam = c; break; }
      }
      await html5QrCode.start(cam.id, { fps: 10, qrbox: { width: 280, height: 280 }, formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE] }, onScanSuccess);
      scannerActive = true;
      setStatus('Camera live — scan QR.');
      startBtn.disabled = true;
      stopBtn.disabled = false;
    } catch(err){
      console.error('Camera start failed', err);
      setStatus('Camera error: ' + (err.message || err));
      showMessage('Camera/device error', 'error');
    }
  }
  async function stopScanner(){ try{ await html5QrCode.stop(); } catch(e){} scannerActive=false; setStatus('Scanner stopped'); startBtn.disabled = false; stopBtn.disabled = true; }

  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);

  // excel load
  excelFile.addEventListener('change', (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    fileStatus.textContent = 'Loading...';
    const fr = new FileReader();
    fr.onload = (e) => {
      try {
        let workbook;
        try { const data = new Uint8Array(e.target.result); workbook = XLSX.read(data, { type: 'array' }); }
        catch(_) { workbook = XLSX.read(e.target.result, { type: 'binary' }); }
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        if(!json || json.length === 0){ fileStatus.textContent = 'Excel empty or no rows.'; return; }
        const headerCandidates = ['id','ID','Id','registration_id','registrationId','reg','reg_id','regid','student_id','studentid'];
        const firstRowKeys = Object.keys(json[0]).map(k => k.trim());
        let idCol = null;
        for(const k of firstRowKeys) if(headerCandidates.includes(k)) { idCol = k; break; }
        if(!idCol) idCol = firstRowKeys[0];
        validIDs = new Set();
        for(const row of json){
          const raw = row[idCol];
          if(raw === undefined || raw === null) continue;
          const s = String(raw).trim();
          if(!s) continue;
          validIDs.add(s.toUpperCase());
        }
        fileStatus.textContent = `✅ Loaded ${validIDs.size} IDs (col: ${idCol})`;
        setStatus('Ready. Click Start Scanning.');
        startBtn.disabled = false;
        stopBtn.disabled = true;
      } catch(err){ console.error('Excel parse failed', err); fileStatus.textContent = 'Failed to parse Excel.'; }
    };
    try{ fr.readAsArrayBuffer(file); } catch(e){ fr.readAsBinaryString(file); }
  });

  // meal buttons: UI highlight & set currentMeal
  function setActive(buttonEl, mealName){
    document.querySelectorAll('.meal-btn').forEach(b => b.classList.remove('active'));
    buttonEl.classList.add('active');
    currentMeal = mealName;
    setStatus(`Mode: ${mealName.toUpperCase()}`);
    // lightly restart scanner to avoid stale reads
    try{ html5QrCode.stop(); } catch(e){}
    setTimeout(()=> { if(!scannerActive) startScanner(); }, 250);
  }
  breakfastBtn.addEventListener('click', ()=> setActive(breakfastBtn, 'breakfast'));
  lunchBtn.addEventListener('click', ()=> setActive(lunchBtn, 'lunch'));
  dinnerBtn.addEventListener('click', ()=> setActive(dinnerBtn, 'dinner'));

  // Download Report (structured rows: ID | Meal | Date | Time)
  downloadBtn.addEventListener('click', async () => {
    downloadBtn.disabled = true;
    const origText = downloadBtn.textContent;
    downloadBtn.textContent = 'Preparing...';
    try {
      const snaps = await getDocs(collection(db, 'meal_records'));
      const rows = [];
      snaps.forEach(s => {
        const d = s.data();
        const meals = d.meals || {};
        if(meals.breakfast_date) rows.push({ ID: d.id || s.id, Meal: 'Breakfast', Date: meals.breakfast_date, Time: meals.breakfast_time || '' });
        if(meals.lunch_date) rows.push({ ID: d.id || s.id, Meal: 'Lunch', Date: meals.lunch_date, Time: meals.lunch_time || '' });
        if(meals.dinner_date) rows.push({ ID: d.id || s.id, Meal: 'Dinner', Date: meals.dinner_date, Time: meals.dinner_time || '' });
      });
      if(rows.length === 0) { alert('No entries found in database.'); }
      else {
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'MealReport');
        XLSX.writeFile(wb, `meal_report_${todayKey()}.xlsx`);
      }
    } catch(err){ console.error('Export failed', err); alert('Export failed — check console.'); }
    downloadBtn.disabled = false;
    downloadBtn.textContent = origText;
  });

  // small utilities
  function todayKey(){ return new Date().toISOString().split('T')[0]; }
  function nowTime(){ return new Date().toLocaleTimeString(); }

  // initial status
  setStatus('Upload Excel (ID column) to begin.');
</script>
</body>
</html>
