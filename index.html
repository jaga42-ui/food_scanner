<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ORC Meal Tracker — Simple & Reliable</title>

  <!-- Tailwind (quick styling) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTML5 QR Code -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { background:#f3f4f6; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto; }
    .card { max-width:760px; margin:28px auto; background:white; padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.06); }
    #reader { width:100%; height:360px; border-radius:10px; overflow:hidden; border:4px solid #2563eb; background:#071427; display:flex; align-items:center; justify-content:center; color:#cfe7ff; }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="text-2xl font-extrabold text-blue-700">ORC Meal Tracker</h1>
    <p class="text-sm text-gray-600 mt-1">Upload Excel → Scan QR → Allowed / Already Taken. When event ends, download DB.</p>

    <div class="mt-4 flex gap-2">
      <button id="breakfastBtn" class="px-3 py-2 rounded bg-blue-600 text-white">Breakfast</button>
      <button id="lunchBtn" class="px-3 py-2 rounded bg-gray-200">Lunch</button>
      <button id="dinnerBtn" class="px-3 py-2 rounded bg-gray-200">Dinner</button>
    </div>

    <div class="mt-4">
      <label class="block text-sm font-semibold">Upload Excel file (first sheet has ID column)</label>
      <input id="excelFile" type="file" accept=".xlsx,.xls" class="mt-2 p-2 border rounded w-full" />
      <div id="fileStatus" class="text-xs text-gray-500 mt-1">No file loaded</div>
    </div>

    <div id="reader" class="mt-4">Camera preview will appear here</div>
    <p id="status" class="mt-3 text-center text-gray-600">Please upload Excel first.</p>

    <div class="mt-4 flex gap-2">
      <button id="startBtn" class="px-4 py-2 bg-green-600 text-white rounded" disabled>Start Scanning</button>
      <button id="stopBtn" class="px-4 py-2 bg-red-500 text-white rounded" disabled>Stop</button>
      <button id="downloadBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Download DB</button>
    </div>

    <div class="mt-4">
      <div id="message" class="text-center text-2xl font-bold h-12"></div>
    </div>

    <div class="mt-4 text-xs text-gray-500">
      Notes: open on mobile via HTTPS (GitHub Pages) or localhost server. Enable Firestore & Anonymous Auth in Firebase Console.
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  // ---------- CONFIG: Replace with your Firebase config if needed ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDlgdYJ9-3ELhEjLz8EQJQK18ghlWhR-jo",
    authDomain: "orc-meal-tracker.firebaseapp.com",
    projectId: "orc-meal-tracker",
    storageBucket: "orc-meal-tracker.firebasestorage.app",
    messagingSenderId: "817313784849",
    appId: "1:817313784849:web:a6597e3981c33c911dbdb0",
    measurementId: "G-H4X37NMPRH"
  };
  // ------------------------------------------------------------------------

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  await signInAnonymously(auth);

  // DOM
  const excelFile = document.getElementById('excelFile');
  const fileStatus = document.getElementById('fileStatus');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const statusEl = document.getElementById('status');
  const messageEl = document.getElementById('message');
  const readerContainerId = 'reader';

  // scanner
  const html5QrCode = new Html5Qrcode(readerContainerId);
  let scannerActive = false;
  let validIDs = new Set();
  let currentMeal = 'breakfast'; // default

  // helpers
  function todayKey(){ return new Date().toISOString().split('T')[0]; }
  function nowTime(){ return new Date().toLocaleTimeString(); }
  function showLargeMessage(text, type='info'){
    messageEl.textContent = text;
    messageEl.style.color = (type === 'success') ? '#059669' : (type === 'error' ? '#dc2626' : '#0ea5e9');
    // clear after 2.5s
    setTimeout(()=> { if(messageEl.textContent === text) messageEl.textContent = ''; }, 2500);
  }

  // ID extraction / normalization
  function extractId(scanned){
    if(!scanned) return null;
    const raw = String(scanned).trim();
    const up = raw.toUpperCase();

    if(validIDs.has(up)) return up;

    // look for id= token
    const m = raw.match(/(?:ID|REGISTRATION_ID|REGID|REG|UID|STUDENT_ID)=([A-Za-z0-9\-_]+)/i);
    if(m && m[1]){
      const cand = m[1].toUpperCase();
      if(validIDs.has(cand)) return cand;
    }

    // token split
    const tokens = up.split(/[^A-Z0-9\-_]+/).filter(Boolean);
    for(const t of tokens) if(validIDs.has(t)) return t;

    // substring search only if set small
    if(validIDs.size > 0 && validIDs.size <= 5000){
      for(const id of validIDs) if(up.includes(id)) return id;
    }
    return null;
  }

  // scan handler
  async function onScanSuccess(decodedText, decodedResult){
    try { await html5QrCode.stop(); } catch(e){}
    scannerActive = false;
    statusEl.textContent = 'Processing...';

    const id = extractId(decodedText);
    if(!id){
      showLargeMessage('❌ Invalid QR', 'error');
      statusEl.textContent = 'Invalid QR. Ready.';
      setTimeout(startScanner, 1200);
      return;
    }

    // check duplicate & save
    try {
      const docRef = doc(db, 'meal_records', id);
      const snap = await getDoc(docRef);
      const date = todayKey();
      const mealDateKey = `${currentMeal}_date`;
      const mealTimeKey = `${currentMeal}_time`;

      if(snap.exists()){
        const data = snap.data();
        const meals = data.meals || {};
        if(meals[mealDateKey] === date){
          showLargeMessage('❌ Already Taken', 'error');
        } else {
          const updatedMeals = { ...meals, [mealDateKey]: date, [mealTimeKey]: nowTime() };
          await updateDoc(docRef, { meals: updatedMeals, lastUpdate: new Date() });
          showLargeMessage('✅ Allowed', 'success');
        }
      } else {
        const newMeals = { [mealDateKey]: date, [mealTimeKey]: nowTime() };
        await setDoc(docRef, { id, meals: newMeals, registeredAt: new Date(), lastUpdate: new Date() });
        showLargeMessage('✅ Allowed', 'success');
      }
      statusEl.textContent = `Processed ${id}. Ready for next.`;
    } catch(err){
      console.error('Save error', err);
      showLargeMessage('❌ Save failed', 'error');
      statusEl.textContent = 'Save error. Check console.';
    } finally {
      setTimeout(startScanner, 900);
    }
  }

  // start / stop scanner
  async function startScanner(){
    if(validIDs.size === 0){
      statusEl.textContent = 'Upload Excel first.';
      return;
    }
    statusEl.textContent = 'Starting camera... (allow permission)';
    try {
      const cameras = await Html5Qrcode.getCameras();
      if(!cameras || cameras.length === 0) throw new Error('No camera found');
      // prefer rear
      let cam = cameras[0];
      for(const c of cameras){
        const lab = (c.label || '').toLowerCase();
        if(lab.includes('back') || lab.includes('rear') || lab.includes('environment')) { cam = c; break; }
      }
      await html5QrCode.start(cam.id, { fps: 10, qrbox: { width: 280, height: 280 }, formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE] }, onScanSuccess);
      scannerActive = true;
      statusEl.textContent = 'Camera live — scan QR.';
      startBtn.disabled = true;
      stopBtn.disabled = false;
    } catch(err){
      console.error('Camera start failed', err);
      statusEl.textContent = 'Camera error: ' + (err.message || err);
      showLargeMessage('Camera error — check permissions', 'error');
    }
  }

  async function stopScanner(){
    try { await html5QrCode.stop(); } catch(e){}
    scannerActive = false;
    statusEl.textContent = 'Scanner stopped.';
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);

  // excel load (robust)
  excelFile.addEventListener('change', (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    fileStatus.textContent = 'Loading...';
    const fr = new FileReader();
    fr.onload = (e) => {
      try {
        let workbook;
        try {
          const data = new Uint8Array(e.target.result);
          workbook = XLSX.read(data, { type: 'array' });
        } catch(_) {
          workbook = XLSX.read(e.target.result, { type: 'binary' });
        }
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        if(!json || json.length === 0){
          fileStatus.textContent = 'Excel empty or no rows found.';
          return;
        }
        // auto-detect ID column
        const headerCandidates = ['id','ID','Id','registration_id','registrationId','reg','reg_id','regid','student_id','studentid'];
        const firstRowKeys = Object.keys(json[0]).map(k => k.trim());
        let idCol = null;
        for(const k of firstRowKeys) if(headerCandidates.includes(k)) { idCol = k; break; }
        if(!idCol) idCol = firstRowKeys[0];
        // build set
        validIDs = new Set();
        for(const row of json){
          const raw = row[idCol];
          if(raw === undefined || raw === null) continue;
          const s = String(raw).trim();
          if(!s) continue;
          validIDs.add(s.toUpperCase());
        }
        fileStatus.textContent = `✅ Loaded ${validIDs.size} IDs (column: ${idCol})`;
        statusEl.textContent = 'Ready. Click Start Scanning.';
        startBtn.disabled = false;
        stopBtn.disabled = true;
      } catch(err){
        console.error('Excel parse failed', err);
        fileStatus.textContent = 'Failed to parse Excel.';
      }
    };
    try { fr.readAsArrayBuffer(file); } catch(e) { fr.readAsBinaryString(file); }
  });

  // mode buttons
  document.getElementById('breakfastBtn').addEventListener('click', () => {
    currentMeal = 'breakfast';
    document.getElementById('status').textContent = 'Mode: BREAKFAST';
  });
  document.getElementById('lunchBtn').addEventListener('click', () => {
    currentMeal = 'lunch';
    document.getElementById('status').textContent = 'Mode: LUNCH';
  });
  document.getElementById('dinnerBtn').addEventListener('click', () => {
    currentMeal = 'dinner';
    document.getElementById('status').textContent = 'Mode: DINNER';
  });

  // download DB button — fetch all docs and create xlsx
  downloadBtn.addEventListener('click', async () => {
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'Preparing...';
    try {
      const snaps = await getDocs(collection(db, 'meal_records'));
      const rows = [];
      snaps.forEach(s => {
        const d = s.data();
        const meals = d.meals || {};
        rows.push({
          ID: d.id || s.id,
          Breakfast_Date: meals.breakfast_date || '',
          Breakfast_Time: meals.breakfast_time || '',
          Lunch_Date: meals.lunch_date || '',
          Lunch_Time: meals.lunch_time || '',
          Dinner_Date: meals.dinner_date || '',
          Dinner_Time: meals.dinner_time || ''
        });
      });
      if(rows.length === 0){ alert('No records in DB.'); }
      else {
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'MealRecords');
        const fname = `meal_records_all_${todayKey()}.xlsx`;
        XLSX.writeFile(wb, fname);
      }
    } catch(err){
      console.error('Export failed', err);
      alert('Export failed — check console.');
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'Download DB';
    }
  });

  // ensure page instructs user
  statusEl.textContent = 'Upload Excel file (ID column) to begin.';
</script>
</body>
</html>
