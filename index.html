<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Guest Food Scanner</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
body { font-family: Arial; text-align: center; padding: 10px; }
button { padding: 12px 20px; margin: 8px; font-size: 18px; width: 150px; }
#result { margin-top: 20px; font-size: 34px; font-weight: bold; }
</style>
</head>
<body>

<h2>Guest Food Scanner</h2>

<div>
  <button onclick="setMeal('breakfast')">Breakfast</button>
  <button onclick="setMeal('lunch')">Lunch</button>
  <button onclick="setMeal('dinner')">Dinner</button>
</div>

<p>Selected Meal: <span id="mealDisplay">None</span></p>

<div id="qr-reader" style="width: 320px; margin:auto;"></div>
<p id="result"></p>

<script>
function doGet(e) {
  var id = (e.parameter.id || "").trim();
  var meal = (e.parameter.meal || "").trim().toLowerCase();
  if (!id || !meal) return ContentService.createTextOutput("INVALID");

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var guests = ss.getSheetByName("Guests");
  var logs = ss.getSheetByName("Logs");

  // -------- VALIDATE GUEST --------
  var guestData = guests.getRange(2, 1, guests.getLastRow() - 1, 1).getValues().flat();
  if (guestData.indexOf(id) === -1) {
    return ContentService.createTextOutput("INVALID");
  }

  // -------- DATE + MEAL UNIQUE CHECK --------
  var today = Utilities.formatDate(new Date(), "Asia/Kolkata", "yyyy-MM-dd");
  var logData = logs.getDataRange().getValues();

  for (var i = 1; i < logData.length; i++) {
    if (logData[i][0] == today && logData[i][1] == id && logData[i][2] == meal) {
      return ContentService.createTextOutput("DENY"); // already taken
    }
  }

  // -------- APPEND ONE UNIQUE ENTRY ONLY --------
  logs.appendRow([today, id, meal, new Date()]);

  return ContentService.createTextOutput("ALLOW");
}

</script>

</body>
</html>
