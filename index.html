<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ORC Smart Meal Access</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- SOUNDS -->
<audio id="successSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
<audio id="errorSound" src="https://assets.mixkit.co/active_storage/sfx/2948/2948-preview.mp3"></audio>

<style>
/* ---------- GLOBAL ANIMATIONS ---------- */
@keyframes glow {
  0% { box-shadow: 0 0 20px #7c3aed; }
  50% { box-shadow: 0 0 50px #a78bfa; }
  100% { box-shadow: 0 0 20px #7c3aed; }
}
@keyframes slideUp {
  from { opacity:0; transform: translateY(60px); }
  to { opacity:1; transform: translateY(0); }
}
@keyframes wipe {
  from { clip-path: inset(0 0 100% 0); }
  to { clip-path: inset(0 0 0 0); }
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.08); }
  100% { transform: scale(1); }
}

.glow { animation: glow 2.5s infinite; }
.slide-up { animation: slideUp 0.9s ease-out forwards; }
.wipe-in { animation: wipe 1s ease-in-out forwards; }
.pulse { animation: pulse 0.6s ease-in-out; }
</style>
</head>

<body class="min-h-screen bg-gradient-to-b from-[#1f1b2e] to-[#36284a] text-white overflow-hidden">

<!-- ================= LOGIN SCREEN ================= -->
<div id="loginScreen" class="fixed inset-0 flex flex-col items-center justify-center">

  <div class="text-center mb-10">
    <h1 class="text-4xl font-extrabold text-purple-400 glow">
      ORC Smart Meal Access
    </h1>
    <p class="text-gray-300 text-sm mt-2">
      Secure QR-Based Meal System
    </p>
  </div>

  <div class="bg-white/10 backdrop-blur-xl p-6 rounded-2xl w-80 slide-up">
    <input id="email" type="email" placeholder="Email"
      class="w-full mb-3 p-2 rounded text-black">
    <input id="password" type="password" placeholder="Password"
      class="w-full mb-4 p-2 rounded text-black">
    <button onclick="login()"
      class="w-full py-2 bg-purple-600 rounded-xl font-bold hover:scale-105 transition">
      Login
    </button>
    <p id="loginError" class="text-red-400 text-sm mt-2"></p>
  </div>
</div>

<!-- ================= APP SCREEN ================= -->
<div id="appScreen" class="hidden fixed inset-0 p-4 wipe-in">

  <div class="max-w-5xl mx-auto bg-white/5 backdrop-blur-xl rounded-2xl p-6 space-y-6 shadow-2xl">

    <header class="text-center">
      <h2 class="text-2xl font-bold text-purple-400">ORC Smart Meal Access</h2>
      <p id="roleText" class="text-gray-300 text-sm"></p>
    </header>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden space-y-3">
      <h3 class="font-bold">Admin Panel</h3>

      <div>
        <label class="text-sm">Select Meal</label>
        <select id="mealSelect"
          class="w-full p-2 rounded text-black"
          onchange="setMeal(this.value)">
        </select>
      </div>

      <button onclick="openDownload()"
        class="py-2 px-4 bg-green-600 rounded-xl font-bold">
        Download Report
      </button>
    </div>

    <!-- SCANNER -->
    <div id="reader"
      class="h-[320px] bg-black/40 rounded-xl border-4 border-white/10 flex items-center justify-center">
      Camera Preview
    </div>

    <div class="text-center">
      <p id="status" class="text-gray-300"></p>
      <p id="message" class="text-xl font-extrabold"></p>
    </div>

    <button onclick="logout()" class="block mx-auto text-xs underline text-gray-400">
      Logout
    </button>

  </div>
</div>

<script>
/* ---------- FIREBASE ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyDlgdYJ9-3ELhEjLz8EQJQK18ghlWhR-jo",
  authDomain: "orc-meal-tracker.firebaseapp.com",
  projectId: "orc-meal-tracker",
  storageBucket: "orc-meal-tracker.firebasestorage.app",
  messagingSenderId: "817313784849",
  appId: "1:817313784849:web:a6597e3981c33c911dbdb0"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------- MEAL CONFIG (FUTURE-PROOF) ---------- */
const MEALS = [
  { key: "breakfast", label: "Breakfast" },
  { key: "lunch", label: "Lunch" },
  { key: "dinner", label: "Dinner" }
  // Add more here later
];

let role = "";
let currentMeal = MEALS[0].key;
let scanner;

/* ---------- HELPERS ---------- */
const today = () => new Date().toISOString().split("T")[0];
const timeNow = () => new Date().toLocaleTimeString();

/* ---------- AUTH ---------- */
function login(){
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(e => loginError.textContent = e.message);
}

function logout(){
  auth.signOut();
}

auth.onAuthStateChanged(async user=>{
  if(!user){
    loginScreen.style.display="flex";
    appScreen.classList.add("hidden");
    return;
  }

  const doc = await db.collection("users").doc(user.uid).get();
  if(!doc.exists){
    status.textContent="No role assigned. Contact admin.";
    return;
  }

  role = doc.data().role;
  roleText.textContent = "Role: " + role.toUpperCase();

  loginScreen.style.display="none";
  appScreen.classList.remove("hidden");

  if(role === "admin"){
    adminPanel.style.display="block";
    loadMealDropdown();
  }
  if(role === "volunteer"){
    startScanner();
  }
});

/* ---------- MEALS ---------- */
function loadMealDropdown(){
  mealSelect.innerHTML="";
  MEALS.forEach(m=>{
    const o=document.createElement("option");
    o.value=m.key;
    o.textContent=m.label;
    mealSelect.appendChild(o);
  });
}

function setMeal(key){
  currentMeal=key;
  status.textContent="Current meal: "+key.toUpperCase();
}

/* ---------- SCANNER ---------- */
async function startScanner(){
  scanner = new Html5Qrcode("reader");
  const cams = await Html5Qrcode.getCameras();
  await scanner.start(cams[0].id,{fps:10,qrbox:250}, async txt=>{
    const id = txt.trim().toUpperCase();
    const ref = db.collection("meal_records").doc(id);
    const snap = await ref.get();
    let meals = snap.exists ? (snap.data().meals||{}) : {};

    if(meals[currentMeal]?.date === today()){
      errorSound.play();
      message.textContent="❌ Already Taken";
    } else {
      meals[currentMeal]={date:today(),time:timeNow()};
      await ref.set({id,meals,lastUpdate:new Date()},{merge:true});
      successSound.play();
      message.textContent="✅ Allowed";
      message.classList.add("pulse");
    }
  });
}

/* ---------- REPORT ---------- */
function openDownload(){
  alert("Report download logic already wired — extend as needed");
}
</script>

</body>
</html>
